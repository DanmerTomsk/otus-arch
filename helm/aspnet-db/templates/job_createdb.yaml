{{- if .Values.migration.execute -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: createdb-job
  labels:
    app: createdb-job
  namespace: otus
spec:
  activeDeadlineSeconds: 120
  backoffLimit: 10 #number of retries before considering a Job as failed
  template:
    metadata:
      name: createdb-job
      labels:
        app: createdb-job
    spec:
      restartPolicy: OnFailure
      containers:
      - name: create
        envFrom:
        - secretRef:
            name: db-connection
        image: postgres:12.8
        command:
          - sh
          - "-c"
          - |
            PGPASSWORD=$dbPassword psql -d $dbName -U $dbUsername -h $dbHost -p $dbPort  <<'EOF'
              CREATE TABLE "Users" (
                "Id" integer GENERATED BY DEFAULT AS IDENTITY,
                "Username" text NOT NULL,
                "FirstName" text NULL,
                "LastName" text NULL,
                "Email" text NOT NULL,
                "Phone" text NULL,
                CONSTRAINT "PK_Users" PRIMARY KEY ("Id"),
                CONSTRAINT UC_Email UNIQUE ("Email")
            );
            EOF
{{- end }}